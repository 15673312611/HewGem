import{u as be,K as ye,r as i,b as he,o as _e,e as a,f as u,g as t,n as z,h as d,y as m,k as V,s as h,j as f,t as I,I as M,v as we,x as ke,m as $,M as G,J as c,ad as Fe,au as Ce,p as Ve,a1 as Ie,T as Ue,av as le,C as j,a9 as Q,aa as X,a8 as De,aw as Ee,_ as Me}from"./vendor-84cddc83.js";import{_ as $e,b as je,u as Le,r as B,c as Ae}from"./index-75d2a32e.js";const Te={class:"min-h-screen bg-gray-50 p-6"},Se={class:"grid grid-cols-[1fr,360px] gap-6 h-full"},ze={class:"bg-white rounded-lg p-8 shadow-sm"},He={class:"h-full flex flex-col"},Oe={class:"mb-6"},Re={key:0,class:"text-red-500 text-xs mt-1"},Be={key:0,class:"w-full h-full relative"},Pe={class:"absolute inset-0 flex items-center justify-center"},Ne=["src"],qe={key:1,class:"text-center"},We={class:"w-20 h-20 bg-blue-50 rounded-full flex items-center justify-center mx-auto mb-6"},Je={class:"text-lg font-medium text-gray-800 mb-3"},Ke={key:0,class:"text-red-500 text-sm mb-3"},Ge={key:2,class:"absolute inset-0 bg-white/80 backdrop-blur-sm flex flex-col items-center justify-center z-50"},Qe={class:"mt-8"},Xe={class:"flex items-center space-x-4 mb-4"},Ye={key:0,class:"text-red-500 text-xs mt-1"},Ze={class:"flex items-center justify-between mt-2"},et={class:"flex items-center"},tt={class:"w-16 h-16 bg-gray-50 rounded-full flex items-center justify-center mb-4"},st={class:"text-gray-500"},rt={key:0,class:"text-xs text-primary mt-2"},lt={class:"flex items-center mt-4"},at=["loading","disabled"],ot={class:"bg-white rounded-lg p-6 shadow-sm"},nt={class:"text-xl font-medium text-gray-800 mb-6"},it={key:0,class:"text-red-500"},ut={class:"mb-6"},dt={class:"flex space-x-4 mb-4"},ct={key:0,class:"text-red-500 text-xs mb-2"},vt={class:"h-[420px] overflow-y-auto pr-4 space-y-3",style:{"scrollbar-width":"thin"}},mt=["onClick"],ft={class:"flex-shrink-0"},pt=["onClick"],gt={class:"flex-1 min-w-0"},xt={class:"flex items-center space-x-2"},bt={class:"text-[#1F2329] font-medium truncate"},yt={class:"flex items-center space-x-2"},ht=["onClick"],_t={class:"flex-shrink-0"},wt=["onClick"],kt={class:"flex-1 min-w-0"},Ft={class:"flex items-center space-x-2"},Ct={class:"text-[#1F2329] font-medium truncate"},Vt={class:"flex items-center"},It=["onClick"],Ut={class:"flex-shrink-0"},Dt=["onClick"],Et={class:"flex-1 min-w-0"},Mt={class:"flex items-center space-x-2"},$t={class:"text-[#1F2329] font-medium truncate"},jt={class:"flex items-center"},Lt={__name:"Create",setup(At){const Y=je(),ae=be(),oe=ye(),P=Le(),L=i("system"),A=i([]),N=i([]),q=i([]),U=i(null),D=i({}),g=i({}),E=i(!0),H=i(null),x=i(null),O=i(!1),b=i(!1),Z=i(null),w=i(null),W=i(""),R=i(!1),k=i(""),p=i(""),_=i(!1),T=i("0"),y=i({name:"",videoFile:null,audioFile:null,text:"",voiceId:null,digitalHumanId:null}),F=i(!1),ne=()=>{H.value.click()},ie=()=>{Z.value.click()},ee=s=>{if(!["video/mp4","video/avi","video/quicktime"].includes(s.type))return c.error("请上传支持的视频格式（MP4、AVI、MOV）"),!1;const l=200*1024*1024;return s.size>l?(c.error("视频文件大小不能超过200MB"),!1):!0},te=s=>{const e=["audio/mp3","audio/mpeg","audio/wav","audio/x-wav"],l=[".mp3",".wav"],o=s.name.toLowerCase().substring(s.name.lastIndexOf("."));if(!(e.includes(s.type)||l.some(r=>o===r)))return c.error("请上传支持的音频格式（MP3、WAV）"),!1;const v=20*1024*1024;return s.size>v?(c.error("音频文件大小不能超过20MB"),!1):!0},ue=s=>{const e=s.target.files[0];e&&(ee(e)&&(x.value=e,p.value=URL.createObjectURL(e)),s.target.value="")},de=s=>{O.value=!1;const e=s.dataTransfer.files[0];e&&ee(e)&&(x.value=e,p.value=URL.createObjectURL(e))},se=s=>new Promise(e=>{const l=new Audio;l.src=URL.createObjectURL(s),l.addEventListener("loadedmetadata",()=>{URL.revokeObjectURL(l.src);const o=Math.floor(l.duration/60),n=Math.floor(l.duration%60);e(`${o}:${n.toString().padStart(2,"0")}`)})}),ce=async s=>{const e=s.target.files[0];e&&(te(e)&&(w.value=e,W.value=await se(e)),s.target.value="")},ve=async s=>{R.value=!1;const e=s.dataTransfer.files[0];e&&te(e)&&(w.value=e,W.value=await se(e))},re=s=>{b.value=s==="audio"},me=async()=>{var s;try{const e=await B.get("/api/voice/favorite/list",{params:{userId:(s=Y.user)==null?void 0:s.id}});A.value=e||[]}catch(e){console.error("获取收藏列表失败:",e),A.value=[]}},fe=async()=>{try{const s=await B.get("/api/voice/hot"),e=new Set(A.value.map(l=>l.id));N.value=s.filter(l=>!e.has(l.id))}catch(s){console.error("获取热门声音失败:",s),N.value=[]}},pe=async()=>{var s;try{const e=await B.get("/api/voice-clone/list",{params:{userId:(s=Y.user)==null?void 0:s.id}});q.value=e||[]}catch(e){console.error("获取自定义音色失败:",e),q.value=[]}},J=s=>{U.value=s},K=s=>{if(!E.value)return;const e=typeof s=="string"?{id:`url_${btoa(s)}`,voiceUrl:s}:{...s,voiceUrl:s.voiceUrl};if(!e.voiceUrl){console.error("音频URL不存在:",e),c.error("音频文件不存在");return}if(Object.entries(D.value).forEach(([o,n])=>{if(o!==e.id)try{n.pause(),n.currentTime=0,g.value[o]=!1}catch(v){console.error("停止其他音频时出错:",v)}}),!D.value[e.id]){const o=new Audio(e.voiceUrl),n=()=>{E.value&&(g.value[e.id]=!1)},v=()=>{E.value&&(console.error("音频加载失败:",e.voiceUrl),g.value[e.id]=!1,c.error("音频加载失败"))};o.addEventListener("ended",n),o.addEventListener("error",v),D.value[e.id]=o}const l=D.value[e.id];if(g.value[e.id])try{l.pause(),l.currentTime=0,g.value[e.id]=!1}catch(o){console.error("暂停音频时出错:",o)}else try{l.play().catch(o=>{E.value&&(console.error("播放失败:",o),g.value[e.id]=!1,c.error("播放失败"))}),g.value[e.id]=!0}catch(o){if(!E.value)return;console.error("播放出错:",o),g.value[e.id]=!1,c.error("播放出错")}};he(()=>{E.value=!1,Object.entries(D.value).forEach(([s,e])=>{try{e.pause(),e.src="",e.removeEventListener("ended",()=>{}),e.removeEventListener("error",()=>{}),g.value[s]=!1}catch(l){console.error("清理音频资源时出错:",l)}}),D.value={},g.value={}}),_e(async()=>{await me(),await fe(),await pe();const{videoUrl:s,digitalHumanId:e,name:l}=oe.query;s&&(p.value=s,e&&(y.value.digitalHumanId=e),l&&(y.value.name=l)),P.currentDigitalHumanVideoUrl&&(p.value=P.currentDigitalHumanVideoUrl,P.clearCurrentDigitalHuman())});const ge=async()=>{var s,e,l,o;if(!_.value){if(F.value=!0,!y.value.name){c.warning("请输入作品名称");return}if(!x.value&&!p.value){c.warning("请上传视频文件");return}if(b.value){if(!w.value){c.warning("请上传音频文件");return}}else{if(!k.value){c.warning("请输入要转换的文本内容");return}if(!U.value){c.warning("请选择音色");return}}try{if(_.value=!0,x.value)try{const r=await Ae(x.value,"tasks/videos");p.value=r}catch(r){c.error("视频上传失败："+r.message),_.value=!1;return}finally{_.value=!1}const n=new FormData;n.append("name",y.value.name),n.append("videoUrl",p.value),y.value.digitalHumanId&&n.append("digitalHumanId",y.value.digitalHumanId),b.value&&w.value?n.append("audio",w.value):(n.append("text",k.value),n.append("voiceId",String(U.value.voiceId))),n.append("userId",localStorage.getItem("userId")),n.append("type",T.value);const v=await B.post("/api/task/create",n);v.code===200?(c.success("任务创建成功"),ae.push("/works")):c.error(v.message||"任务创建失败")}catch(n){((s=n.response)==null?void 0:s.status)===401||((e=n.response)==null?void 0:e.status)===403?showLoginModal():c.error(((o=(l=n.response)==null?void 0:l.data)==null?void 0:o.message)||"任务创建失败")}finally{_.value=!1}}},xe=()=>{p.value="",x.value=null,H.value&&(H.value.value="")};return(s,e)=>{const l=Fe,o=Ee,n=Ce,v=Me;return a(),u("div",Te,[t("div",Se,[t("div",ze,[t("div",He,[t("div",Oe,[e[12]||(e[12]=t("label",{class:"block text-sm font-medium text-gray-700 mb-2"},[z("作品名称 "),t("span",{class:"text-red-500"},"*")],-1)),d(l,{modelValue:y.value.name,"onUpdate:modelValue":e[0]||(e[0]=r=>y.value.name=r),placeholder:"请输入作品名称",maxlength:50,"show-word-limit":"",class:m({"is-error":!y.value.name&&F.value})},null,8,["modelValue","class"]),!y.value.name&&F.value?(a(),u("div",Re,"请输入作品名称")):V("",!0)]),t("div",{class:m(["flex-1 border-2 border-dashed border-gray-200 rounded-lg flex flex-col items-center justify-center cursor-pointer hover:border-primary/60 transition-colors min-h-[330px]",{"border-primary/60 bg-blue-50/30":O.value,"border-red-500":!x.value&&!p.value&&F.value}]),onDrop:h(de,["prevent"]),onDragover:e[1]||(e[1]=h(r=>O.value=!0,["prevent"])),onDragleave:e[2]||(e[2]=h(r=>O.value=!1,["prevent"])),onClick:ne},[t("input",{type:"file",ref_key:"fileInput",ref:H,class:"hidden",onChange:ue,accept:".mp4,.avi,.mov"},null,544),p.value?(a(),u("div",Be,[t("div",Pe,[t("video",{src:p.value,class:"max-w-[90%] max-h-[90%] object-contain",controls:""},null,8,Ne)]),t("button",{onClick:h(xe,["stop"]),class:"absolute top-2 right-2 p-1.5 bg-black/50 text-white rounded-full hover:bg-black/70 transition-colors"},[d(f(Ve),{class:"w-5 h-5"})])])):(a(),u("div",qe,[t("div",We,[d(f(Ie),{class:"w-10 h-10 text-primary"})]),t("div",Je,[z(I(x.value?x.value.name:"点击或拖拽视频到这里")+" ",1),e[13]||(e[13]=t("span",{class:"text-red-500"},"*",-1))]),!x.value&&F.value?(a(),u("div",Ke,"请上传视频文件")):V("",!0),e[14]||(e[14]=t("div",{class:"text-sm text-gray-500 mb-4"},"支持的格式：",-1)),e[15]||(e[15]=t("div",{class:"text-sm text-gray-400"},[t("div",{class:"mb-1"},"视频：MP4、AVI、MOV (不超过200MB)")],-1))])),_.value?(a(),u("div",Ge,e[16]||(e[16]=[t("div",{class:"w-24 h-24 rounded-full bg-blue-50 flex items-center justify-center mb-6"},[t("div",{class:"animate-spin rounded-full h-16 w-16 border-b-2 border-primary"})],-1),t("div",{class:"text-lg font-medium text-gray-800 mb-2"},"正在合成中",-1),t("div",{class:"text-sm text-gray-500"},"请稍候，我们正在为您生成视频...",-1)]))):V("",!0)],34),t("div",Qe,[t("div",Xe,[t("button",{class:m(["flex items-center px-6 py-2.5 rounded-lg transition-colors",[b.value?"text-gray-700 hover:bg-gray-50":"text-primary bg-blue-50 hover:bg-blue-100"]]),onClick:e[3]||(e[3]=r=>re("text"))},[d(f(Ue),{class:"w-5 h-5 mr-2"}),e[17]||(e[17]=z(" 文本转语音 "))],2),t("button",{class:m(["flex items-center px-6 py-2.5 rounded-lg transition-colors",[b.value?"text-primary bg-blue-50 hover:bg-blue-100":"text-gray-700 hover:bg-gray-50"]]),onClick:e[4]||(e[4]=r=>re("audio"))},[d(f(le),{class:"w-5 h-5 mr-2"}),e[18]||(e[18]=z(" 上传音频 "))],2)]),b.value?(a(),u(M,{key:1},[t("div",{class:m(["w-full bg-white rounded-lg p-4 text-sm text-gray-700 border border-gray-200 min-h-[200px] flex flex-col items-center justify-center cursor-pointer",{"border-primary/60 bg-blue-50/30":R.value}]),onClick:ie,onDrop:h(ve,["prevent"]),onDragover:e[7]||(e[7]=h(r=>R.value=!0,["prevent"])),onDragleave:e[8]||(e[8]=h(r=>R.value=!1,["prevent"]))},[t("input",{type:"file",ref_key:"audioInput",ref:Z,class:"hidden",onChange:ce,accept:".mp3,.wav"},null,544),t("div",tt,[d(f(le),{class:"w-8 h-8 text-gray-400"})]),t("div",st,I(w.value?w.value.name:"点击或拖拽音频文件到这里"),1),w.value?(a(),u("div",rt,"时长："+I(W.value),1)):V("",!0),e[20]||(e[20]=t("div",{class:"text-xs text-gray-400 mt-2"},"支持MP3、WAV格式，不超过20MB",-1))],34),t("div",lt,[e[21]||(e[21]=t("label",{class:"text-sm text-gray-700 mr-2"},"合成线路：",-1)),d(n,{modelValue:T.value,"onUpdate:modelValue":e[9]||(e[9]=r=>T.value=r),placeholder:"请选择线路",size:"small",style:{width:"120px"}},{default:$(()=>[d(o,{label:"普通线路",value:"0"}),d(o,{label:"高级线路",value:"1"})]),_:1},8,["modelValue"])])],64)):(a(),u(M,{key:0},[we(t("textarea",{"onUpdate:modelValue":e[5]||(e[5]=r=>k.value=r),rows:"6",placeholder:"请输入要转换的文本内容（最多450字）；在点击开始生成后，请耐心等待，不要进行切换或者刷新页面。注意！不要输入或上传反法相关内容，又或侵犯第三方权益或版权内容。服务器日志均有详细记录。",class:m(["w-full bg-gray-50 rounded-lg p-4 text-sm text-gray-700 placeholder-gray-400 resize-none focus:outline-none focus:ring-1 focus:ring-primary/30 border border-gray-100",{"border-red-500":!k.value&&F.value&&!b.value}])},null,2),[[ke,k.value]]),!k.value&&F.value&&!b.value?(a(),u("div",Ye,"请输入要转换的文本内容")):V("",!0),t("div",Ze,[t("div",et,[e[19]||(e[19]=t("label",{class:"text-sm text-gray-700 mr-2"},"合成线路：",-1)),d(n,{modelValue:T.value,"onUpdate:modelValue":e[6]||(e[6]=r=>T.value=r),placeholder:"请选择线路",size:"small",style:{width:"120px"}},{default:$(()=>[d(o,{label:"普通线路",value:"0"}),d(o,{label:"高级线路",value:"1"})]),_:1},8,["modelValue"])]),t("div",{class:m([{"text-red-500":k.value.length>450},"text-xs text-gray-500"])},I(k.value.length)+"/450",3)])],64))]),t("button",{class:"mt-8 w-full bg-gradient-to-r from-primary to-blue-600 text-white py-3.5 rounded-lg font-medium hover:opacity-90 transition-opacity shadow-sm",onClick:ge,loading:_.value,disabled:_.value},I(_.value?"创建中...":"创建"),9,at)])]),t("div",ot,[t("h2",nt,[e[22]||(e[22]=z("选择音色 ")),b.value?V("",!0):(a(),u("span",it,"*"))]),t("div",ut,[t("div",dt,[t("button",{onClick:e[10]||(e[10]=r=>L.value="system"),class:m(["px-4 py-2 rounded-lg transition-all duration-300",L.value==="system"?"bg-[#FF5722] text-white":"bg-white text-gray-700 border border-gray-200"])}," 系统音色 ",2),t("button",{onClick:e[11]||(e[11]=r=>L.value="custom"),class:m(["px-4 py-2 rounded-lg transition-all duration-300",L.value==="custom"?"bg-[#FF5722] text-white":"bg-white text-gray-700 border border-gray-200"])}," 自定义音色 ",2)]),!U.value&&F.value&&!b.value?(a(),u("div",ct,"请选择音色")):V("",!0),t("div",vt,[L.value==="system"?(a(),u(M,{key:0},[A.value.length>0?(a(!0),u(M,{key:0},G(A.value,r=>{var C;return a(),u("div",{key:"fav-"+r.id,class:m(["bg-white rounded-lg p-4 flex items-start space-x-3 hover:bg-gray-50 transition-colors group cursor-pointer",{"border-2 border-[#FF5722]":((C=U.value)==null?void 0:C.id)===r.id}]),onClick:S=>J(r)},[t("div",ft,[t("button",{onClick:h(S=>K(r),["stop"]),class:"w-12 h-12 rounded-full bg-[#FFF7F0] flex items-center justify-center group-hover:bg-[#FFE4D1] transition-colors relative"},e[23]||(e[23]=[t("div",{class:"w-0 h-0 border-t-[8px] border-t-transparent border-l-[12px] border-l-[#FF5722] border-b-[8px] border-b-transparent ml-1"},null,-1)]),8,pt)]),t("div",gt,[t("div",xt,[t("h3",bt,I(r.name),1),t("div",yt,[d(v,{size:16,color:r.gender===1?"#409EFF":"#F56C6C"},{default:$(()=>[r.gender===1?(a(),j(f(Q),{key:0})):(a(),j(f(X),{key:1}))]),_:2},1032,["color"]),d(v,{size:16,class:"text-[#FF5722]"},{default:$(()=>[d(f(De))]),_:1})])]),e[24]||(e[24]=t("div",{class:"text-[#646A73] text-sm mt-1"},"中文",-1))])],10,mt)}),128)):V("",!0),(a(!0),u(M,null,G(N.value,r=>{var C;return a(),u("div",{key:"hot-"+r.id,class:m(["bg-white rounded-lg p-4 flex items-start space-x-3 hover:bg-gray-50 transition-colors group cursor-pointer",{"border-2 border-[#FF5722]":((C=U.value)==null?void 0:C.id)===r.id}]),onClick:S=>J(r)},[t("div",_t,[t("button",{onClick:h(S=>K(r),["stop"]),class:"w-12 h-12 rounded-full bg-[#FFF7F0] flex items-center justify-center group-hover:bg-[#FFE4D1] transition-colors relative"},e[25]||(e[25]=[t("div",{class:"w-0 h-0 border-t-[8px] border-t-transparent border-l-[12px] border-l-[#FF5722] border-b-[8px] border-b-transparent ml-1"},null,-1)]),8,wt)]),t("div",kt,[t("div",Ft,[t("h3",Ct,I(r.name),1),t("div",Vt,[d(v,{size:16,color:r.gender===1?"#409EFF":"#F56C6C"},{default:$(()=>[r.gender===1?(a(),j(f(Q),{key:0})):(a(),j(f(X),{key:1}))]),_:2},1032,["color"])])]),e[26]||(e[26]=t("div",{class:"text-[#646A73] text-sm mt-1"},"中文",-1))])],10,ht)}),128))],64)):(a(!0),u(M,{key:1},G(q.value,r=>{var C;return a(),u("div",{key:r.id,class:m(["bg-white rounded-lg p-4 flex items-start space-x-3 hover:bg-gray-50 transition-colors group cursor-pointer",{"border-2 border-[#FF5722]":((C=U.value)==null?void 0:C.id)===r.id}]),onClick:S=>J(r)},[t("div",Ut,[t("button",{onClick:h(S=>K(r),["stop"]),class:"w-12 h-12 rounded-full bg-[#FFF7F0] flex items-center justify-center group-hover:bg-[#FFE4D1] transition-colors relative"},e[27]||(e[27]=[t("div",{class:"w-0 h-0 border-t-[8px] border-t-transparent border-l-[12px] border-l-[#FF5722] border-b-[8px] border-b-transparent ml-1"},null,-1)]),8,Dt)]),t("div",Et,[t("div",Mt,[t("h3",$t,I(r.name),1),t("div",jt,[d(v,{size:16,color:r.gender===1?"#409EFF":"#F56C6C"},{default:$(()=>[r.gender===1?(a(),j(f(Q),{key:0})):(a(),j(f(X),{key:1}))]),_:2},1032,["color"])])]),e[28]||(e[28]=t("div",{class:"text-[#646A73] text-sm mt-1"},"中文",-1))])],10,It)}),128))])])])])])}}},zt=$e(Lt,[["__scopeId","data-v-cf8e0fb9"]]);export{zt as default};
