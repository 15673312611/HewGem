import{u as pe,K as ge,r as n,b as xe,o as be,e as o,f as i,g as t,n as E,h as v,y as m,k,s as y,j as c,t as F,I as L,v as ye,x as he,M as W,J as u,ad as _e,p as we,a1 as ke,T as Fe,au as te,av as Ce,m as H,C as M,a9 as J,aa as K,a8 as Ve,_ as Ie}from"./vendor-13b14bae.js";import{_ as Ue,b as De,u as Ee,r as z}from"./index-2008dd6c.js";const Me={class:"min-h-screen bg-gray-50 p-6"},$e={class:"grid grid-cols-[1fr,360px] gap-6 h-full"},je={class:"bg-white rounded-lg p-8 shadow-sm"},Le={class:"h-full flex flex-col"},Ae={class:"mb-6"},Se={key:0,class:"text-red-500 text-xs mt-1"},Te={key:0,class:"w-full h-full relative"},He={class:"absolute inset-0 flex items-center justify-center"},ze=["src"],Re={key:1,class:"text-center"},Oe={class:"w-20 h-20 bg-blue-50 rounded-full flex items-center justify-center mx-auto mb-6"},Be={class:"text-lg font-medium text-gray-800 mb-3"},Pe={key:0,class:"text-red-500 text-sm mb-3"},Ne={key:2,class:"absolute inset-0 bg-white/80 backdrop-blur-sm flex flex-col items-center justify-center z-50"},qe={class:"mt-8"},We={class:"flex items-center space-x-4 mb-4"},Je={key:0,class:"text-red-500 text-xs mt-1"},Ke={class:"flex justify-between items-center mt-2 text-xs text-gray-500"},Ge={class:"flex items-center"},Qe={class:"w-16 h-16 bg-gray-50 rounded-full flex items-center justify-center mb-4"},Xe={class:"text-gray-500"},Ye={key:0,class:"text-xs text-primary mt-2"},Ze=["loading","disabled"],et={class:"bg-white rounded-lg p-6 shadow-sm"},tt={class:"text-xl font-medium text-gray-800 mb-6"},st={key:0,class:"text-red-500"},rt={class:"mb-6"},at={class:"flex space-x-4 mb-4"},ot={key:0,class:"text-red-500 text-xs mb-2"},lt={class:"h-[420px] overflow-y-auto pr-4 space-y-3",style:{"scrollbar-width":"thin"}},nt=["onClick"],it={class:"flex-shrink-0"},dt=["onClick"],ut={class:"flex-1 min-w-0"},ct={class:"flex items-center space-x-2"},vt={class:"text-[#1F2329] font-medium truncate"},mt={class:"flex items-center space-x-2"},ft=["onClick"],pt={class:"flex-shrink-0"},gt=["onClick"],xt={class:"flex-1 min-w-0"},bt={class:"flex items-center space-x-2"},yt={class:"text-[#1F2329] font-medium truncate"},ht={class:"flex items-center"},_t=["onClick"],wt={class:"flex-shrink-0"},kt=["onClick"],Ft={class:"flex-1 min-w-0"},Ct={class:"flex items-center space-x-2"},Vt={class:"text-[#1F2329] font-medium truncate"},It={class:"flex items-center"},Ut={__name:"Create",setup(Dt){const G=De(),se=pe(),re=ge(),R=Ee(),$=n("system"),j=n([]),O=n([]),B=n([]),C=n(null),U=n({}),p=n({}),D=n(!0),A=n(null),g=n(null),S=n(!1),x=n(!1),Q=n(null),h=n(null),P=n(""),T=n(!1),_=n(""),f=n(""),V=n(!1),b=n({name:"",videoFile:null,audioFile:null,text:"",voiceId:null,digitalHumanId:null}),w=n(!1),ae=()=>{A.value.click()},oe=()=>{Q.value.click()},X=r=>{if(!["video/mp4","video/avi","video/quicktime"].includes(r.type))return u.error("请上传支持的视频格式（MP4、AVI、MOV）"),!1;const a=200*1024*1024;return r.size>a?(u.error("视频文件大小不能超过200MB"),!1):!0},Y=r=>{const e=["audio/mp3","audio/mpeg","audio/wav","audio/x-wav"],a=[".mp3",".wav"],l=r.name.toLowerCase().substring(r.name.lastIndexOf("."));if(!(e.includes(r.type)||a.some(I=>l===I)))return u.error("请上传支持的音频格式（MP3、WAV）"),!1;const d=20*1024*1024;return r.size>d?(u.error("音频文件大小不能超过20MB"),!1):!0},le=r=>{const e=r.target.files[0];e&&(X(e)&&(g.value=e,f.value=URL.createObjectURL(e)),r.target.value="")},ne=r=>{S.value=!1;const e=r.dataTransfer.files[0];e&&X(e)&&(g.value=e,f.value=URL.createObjectURL(e))},Z=r=>new Promise(e=>{const a=new Audio;a.src=URL.createObjectURL(r),a.addEventListener("loadedmetadata",()=>{URL.revokeObjectURL(a.src);const l=Math.floor(a.duration/60),s=Math.floor(a.duration%60);e(`${l}:${s.toString().padStart(2,"0")}`)})}),ie=async r=>{const e=r.target.files[0];e&&(Y(e)&&(h.value=e,P.value=await Z(e)),r.target.value="")},de=async r=>{T.value=!1;const e=r.dataTransfer.files[0];e&&Y(e)&&(h.value=e,P.value=await Z(e))},ee=r=>{x.value=r==="audio"},ue=async()=>{var r;try{const e=await z.get("/api/voice/favorite/list",{params:{userId:(r=G.user)==null?void 0:r.id}});j.value=e||[]}catch(e){console.error("获取收藏列表失败:",e),j.value=[]}},ce=async()=>{try{const r=await z.get("/api/voice/hot"),e=new Set(j.value.map(a=>a.id));O.value=r.filter(a=>!e.has(a.id))}catch(r){console.error("获取热门声音失败:",r),O.value=[]}},ve=async()=>{var r;try{const e=await z.get("/api/voice-clone/list",{params:{userId:(r=G.user)==null?void 0:r.id}});B.value=e||[]}catch(e){console.error("获取自定义音色失败:",e),B.value=[]}},N=r=>{C.value=r},q=r=>{if(!D.value)return;const e=typeof r=="string"?{id:`url_${btoa(r)}`,voiceUrl:r}:{...r,voiceUrl:r.voiceUrl};if(!e.voiceUrl){console.error("音频URL不存在:",e),u.error("音频文件不存在");return}if(Object.entries(U.value).forEach(([l,s])=>{if(l!==e.id)try{s.pause(),s.currentTime=0,p.value[l]=!1}catch(d){console.error("停止其他音频时出错:",d)}}),!U.value[e.id]){const l=new Audio(e.voiceUrl),s=()=>{D.value&&(p.value[e.id]=!1)},d=()=>{D.value&&(console.error("音频加载失败:",e.voiceUrl),p.value[e.id]=!1,u.error("音频加载失败"))};l.addEventListener("ended",s),l.addEventListener("error",d),U.value[e.id]=l}const a=U.value[e.id];if(p.value[e.id])try{a.pause(),a.currentTime=0,p.value[e.id]=!1}catch(l){console.error("暂停音频时出错:",l)}else try{a.play().catch(l=>{D.value&&(console.error("播放失败:",l),p.value[e.id]=!1,u.error("播放失败"))}),p.value[e.id]=!0}catch(l){if(!D.value)return;console.error("播放出错:",l),p.value[e.id]=!1,u.error("播放出错")}};xe(()=>{D.value=!1,Object.entries(U.value).forEach(([r,e])=>{try{e.pause(),e.src="",e.removeEventListener("ended",()=>{}),e.removeEventListener("error",()=>{}),p.value[r]=!1}catch(a){console.error("清理音频资源时出错:",a)}}),U.value={},p.value={}}),be(async()=>{await ue(),await ce(),await ve();const{videoUrl:r,digitalHumanId:e,name:a}=re.query;r&&(f.value=r,e&&(b.value.digitalHumanId=e),a&&(b.value.name=a)),R.currentDigitalHumanVideoUrl&&(f.value=R.currentDigitalHumanVideoUrl,R.clearCurrentDigitalHuman())});const me=async()=>{var r,e,a,l;if(!V.value){if(w.value=!0,!b.value.name){u.warning("请输入作品名称");return}if(!g.value&&!f.value){u.warning("请上传视频文件");return}if(x.value){if(!h.value){u.warning("请上传音频文件");return}}else{if(!_.value){u.warning("请输入要转换的文本内容");return}if(!C.value){u.warning("请选择音色");return}}try{V.value=!0;const s=new FormData;s.append("name",b.value.name),g.value?s.append("video",g.value):f.value&&s.append("videoUrl",f.value),b.value.digitalHumanId&&s.append("digitalHumanId",b.value.digitalHumanId),x.value&&h.value?s.append("audio",h.value):(s.append("text",_.value),s.append("voiceId",String(C.value.voiceId))),s.append("userId",localStorage.getItem("userId"));const d=await z.post("/api/task/create",s);d.code===200?(u.success("任务创建成功"),se.push("/works")):u.error(d.message||"任务创建失败")}catch(s){((r=s.response)==null?void 0:r.status)===401||((e=s.response)==null?void 0:e.status)===403?showLoginModal():u.error(((l=(a=s.response)==null?void 0:a.data)==null?void 0:l.message)||"任务创建失败")}finally{V.value=!1}}},fe=()=>{f.value="",g.value=null,A.value&&(A.value.value="")};return(r,e)=>{const a=_e,l=Ie;return o(),i("div",Me,[t("div",$e,[t("div",je,[t("div",Le,[t("div",Ae,[e[10]||(e[10]=t("label",{class:"block text-sm font-medium text-gray-700 mb-2"},[E("作品名称 "),t("span",{class:"text-red-500"},"*")],-1)),v(a,{modelValue:b.value.name,"onUpdate:modelValue":e[0]||(e[0]=s=>b.value.name=s),placeholder:"请输入作品名称",maxlength:50,"show-word-limit":"",class:m({"is-error":!b.value.name&&w.value})},null,8,["modelValue","class"]),!b.value.name&&w.value?(o(),i("div",Se,"请输入作品名称")):k("",!0)]),t("div",{class:m(["flex-1 border-2 border-dashed border-gray-200 rounded-lg flex flex-col items-center justify-center cursor-pointer hover:border-primary/60 transition-colors min-h-[330px]",{"border-primary/60 bg-blue-50/30":S.value,"border-red-500":!g.value&&!f.value&&w.value}]),onDrop:y(ne,["prevent"]),onDragover:e[1]||(e[1]=y(s=>S.value=!0,["prevent"])),onDragleave:e[2]||(e[2]=y(s=>S.value=!1,["prevent"])),onClick:ae},[t("input",{type:"file",ref_key:"fileInput",ref:A,class:"hidden",onChange:le,accept:".mp4,.avi,.mov"},null,544),f.value?(o(),i("div",Te,[t("div",He,[t("video",{src:f.value,class:"max-w-[90%] max-h-[90%] object-contain",controls:""},null,8,ze)]),t("button",{onClick:y(fe,["stop"]),class:"absolute top-2 right-2 p-1.5 bg-black/50 text-white rounded-full hover:bg-black/70 transition-colors"},[v(c(we),{class:"w-5 h-5"})])])):(o(),i("div",Re,[t("div",Oe,[v(c(ke),{class:"w-10 h-10 text-primary"})]),t("div",Be,[E(F(g.value?g.value.name:"点击或拖拽视频到这里")+" ",1),e[11]||(e[11]=t("span",{class:"text-red-500"},"*",-1))]),!g.value&&w.value?(o(),i("div",Pe,"请上传视频文件")):k("",!0),e[12]||(e[12]=t("div",{class:"text-sm text-gray-500 mb-4"},"支持的格式：",-1)),e[13]||(e[13]=t("div",{class:"text-sm text-gray-400"},[t("div",{class:"mb-1"},"视频：MP4、AVI、MOV (不超过200MB)")],-1))])),V.value?(o(),i("div",Ne,e[14]||(e[14]=[t("div",{class:"w-24 h-24 rounded-full bg-blue-50 flex items-center justify-center mb-6"},[t("div",{class:"animate-spin rounded-full h-16 w-16 border-b-2 border-primary"})],-1),t("div",{class:"text-lg font-medium text-gray-800 mb-2"},"正在合成中",-1),t("div",{class:"text-sm text-gray-500"},"请稍候，我们正在为您生成视频...",-1)]))):k("",!0)],34),t("div",qe,[t("div",We,[t("button",{class:m(["flex items-center px-6 py-2.5 rounded-lg transition-colors",[x.value?"text-gray-700 hover:bg-gray-50":"text-primary bg-blue-50 hover:bg-blue-100"]]),onClick:e[3]||(e[3]=s=>ee("text"))},[v(c(Fe),{class:"w-5 h-5 mr-2"}),e[15]||(e[15]=E(" 文本转语音 "))],2),t("button",{class:m(["flex items-center px-6 py-2.5 rounded-lg transition-colors",[x.value?"text-primary bg-blue-50 hover:bg-blue-100":"text-gray-700 hover:bg-gray-50"]]),onClick:e[4]||(e[4]=s=>ee("audio"))},[v(c(te),{class:"w-5 h-5 mr-2"}),e[16]||(e[16]=E(" 上传音频 "))],2)]),x.value?(o(),i("div",{key:1,class:m(["w-full bg-white rounded-lg p-4 text-sm text-gray-700 border border-gray-200 min-h-[200px] flex flex-col items-center justify-center cursor-pointer",{"border-primary/60 bg-blue-50/30":T.value}]),onClick:oe,onDrop:y(de,["prevent"]),onDragover:e[6]||(e[6]=y(s=>T.value=!0,["prevent"])),onDragleave:e[7]||(e[7]=y(s=>T.value=!1,["prevent"]))},[t("input",{type:"file",ref_key:"audioInput",ref:Q,class:"hidden",onChange:ie,accept:".mp3,.wav"},null,544),t("div",Qe,[v(c(te),{class:"w-8 h-8 text-gray-400"})]),t("div",Xe,F(h.value?h.value.name:"点击或拖拽音频文件到这里"),1),h.value?(o(),i("div",Ye,"时长："+F(P.value),1)):k("",!0),e[18]||(e[18]=t("div",{class:"text-xs text-gray-400 mt-2"},"支持MP3、WAV格式，不超过20MB",-1))],34)):(o(),i(L,{key:0},[ye(t("textarea",{"onUpdate:modelValue":e[5]||(e[5]=s=>_.value=s),rows:"6",placeholder:"请输入要转换的文本内容（最多450字）；在点击开始生成后，请耐心等待，不要进行切换或者刷新页面。注意！不要输入或上传反法相关内容，又或侵犯第三方权益或版权内容。服务器日志均有详细记录。",class:m(["w-full bg-gray-50 rounded-lg p-4 text-sm text-gray-700 placeholder-gray-400 resize-none focus:outline-none focus:ring-1 focus:ring-primary/30 border border-gray-100",{"border-red-500":!_.value&&w.value&&!x.value}])},null,2),[[he,_.value]]),!_.value&&w.value&&!x.value?(o(),i("div",Je,"请输入要转换的文本内容")):k("",!0),t("div",Ke,[t("div",Ge,[v(c(Ce),{class:"w-4 h-4 mr-1 text-yellow-500"}),e[17]||(e[17]=E(" 升级为高级会员可输入最多1200字 "))]),t("div",{class:m({"text-red-500":_.value.length>450})},F(_.value.length)+"/450",3)])],64))]),t("button",{class:"mt-8 w-full bg-gradient-to-r from-primary to-blue-600 text-white py-3.5 rounded-lg font-medium hover:opacity-90 transition-opacity shadow-sm",onClick:me,loading:V.value,disabled:V.value},F(V.value?"创建中...":"创建"),9,Ze)])]),t("div",et,[t("h2",tt,[e[19]||(e[19]=E("选择音色 ")),x.value?k("",!0):(o(),i("span",st,"*"))]),t("div",rt,[t("div",at,[t("button",{onClick:e[8]||(e[8]=s=>$.value="system"),class:m(["px-4 py-2 rounded-lg transition-all duration-300",$.value==="system"?"bg-[#FF5722] text-white":"bg-white text-gray-700 border border-gray-200"])}," 系统音色 ",2),t("button",{onClick:e[9]||(e[9]=s=>$.value="custom"),class:m(["px-4 py-2 rounded-lg transition-all duration-300",$.value==="custom"?"bg-[#FF5722] text-white":"bg-white text-gray-700 border border-gray-200"])}," 自定义音色 ",2)]),!C.value&&w.value&&!x.value?(o(),i("div",ot,"请选择音色")):k("",!0),t("div",lt,[$.value==="system"?(o(),i(L,{key:0},[j.value.length>0?(o(!0),i(L,{key:0},W(j.value,s=>{var d;return o(),i("div",{key:"fav-"+s.id,class:m(["bg-white rounded-lg p-4 flex items-start space-x-3 hover:bg-gray-50 transition-colors group cursor-pointer",{"border-2 border-[#FF5722]":((d=C.value)==null?void 0:d.id)===s.id}]),onClick:I=>N(s)},[t("div",it,[t("button",{onClick:y(I=>q(s),["stop"]),class:"w-12 h-12 rounded-full bg-[#FFF7F0] flex items-center justify-center group-hover:bg-[#FFE4D1] transition-colors relative"},e[20]||(e[20]=[t("div",{class:"w-0 h-0 border-t-[8px] border-t-transparent border-l-[12px] border-l-[#FF5722] border-b-[8px] border-b-transparent ml-1"},null,-1)]),8,dt)]),t("div",ut,[t("div",ct,[t("h3",vt,F(s.name),1),t("div",mt,[v(l,{size:16,color:s.gender===1?"#409EFF":"#F56C6C"},{default:H(()=>[s.gender===1?(o(),M(c(J),{key:0})):(o(),M(c(K),{key:1}))]),_:2},1032,["color"]),v(l,{size:16,class:"text-[#FF5722]"},{default:H(()=>[v(c(Ve))]),_:1})])]),e[21]||(e[21]=t("div",{class:"text-[#646A73] text-sm mt-1"},"中文",-1))])],10,nt)}),128)):k("",!0),(o(!0),i(L,null,W(O.value,s=>{var d;return o(),i("div",{key:"hot-"+s.id,class:m(["bg-white rounded-lg p-4 flex items-start space-x-3 hover:bg-gray-50 transition-colors group cursor-pointer",{"border-2 border-[#FF5722]":((d=C.value)==null?void 0:d.id)===s.id}]),onClick:I=>N(s)},[t("div",pt,[t("button",{onClick:y(I=>q(s),["stop"]),class:"w-12 h-12 rounded-full bg-[#FFF7F0] flex items-center justify-center group-hover:bg-[#FFE4D1] transition-colors relative"},e[22]||(e[22]=[t("div",{class:"w-0 h-0 border-t-[8px] border-t-transparent border-l-[12px] border-l-[#FF5722] border-b-[8px] border-b-transparent ml-1"},null,-1)]),8,gt)]),t("div",xt,[t("div",bt,[t("h3",yt,F(s.name),1),t("div",ht,[v(l,{size:16,color:s.gender===1?"#409EFF":"#F56C6C"},{default:H(()=>[s.gender===1?(o(),M(c(J),{key:0})):(o(),M(c(K),{key:1}))]),_:2},1032,["color"])])]),e[23]||(e[23]=t("div",{class:"text-[#646A73] text-sm mt-1"},"中文",-1))])],10,ft)}),128))],64)):(o(!0),i(L,{key:1},W(B.value,s=>{var d;return o(),i("div",{key:s.id,class:m(["bg-white rounded-lg p-4 flex items-start space-x-3 hover:bg-gray-50 transition-colors group cursor-pointer",{"border-2 border-[#FF5722]":((d=C.value)==null?void 0:d.id)===s.id}]),onClick:I=>N(s)},[t("div",wt,[t("button",{onClick:y(I=>q(s),["stop"]),class:"w-12 h-12 rounded-full bg-[#FFF7F0] flex items-center justify-center group-hover:bg-[#FFE4D1] transition-colors relative"},e[24]||(e[24]=[t("div",{class:"w-0 h-0 border-t-[8px] border-t-transparent border-l-[12px] border-l-[#FF5722] border-b-[8px] border-b-transparent ml-1"},null,-1)]),8,kt)]),t("div",Ft,[t("div",Ct,[t("h3",Vt,F(s.name),1),t("div",It,[v(l,{size:16,color:s.gender===1?"#409EFF":"#F56C6C"},{default:H(()=>[s.gender===1?(o(),M(c(J),{key:0})):(o(),M(c(K),{key:1}))]),_:2},1032,["color"])])]),e[25]||(e[25]=t("div",{class:"text-[#646A73] text-sm mt-1"},"中文",-1))])],10,_t)}),128))])])])])])}}},$t=Ue(Ut,[["__scopeId","data-v-efbdbbd7"]]);export{$t as default};
